#!/usr/bin/python
# coding=utf-8


import argparse
import os.path
import sys
import json

sys.path = ([sys.path[0]]
            + [os.path.join(os.path.dirname(__file__), "../lib")]
            + sys.path[1:])
import dataprocessor.pipes.jsonio
import dataprocessor.pipes.figure
sys.path = [sys.path[0]] + sys.path[2:]


def read_args():
    parser = argparse.ArgumentParser(description="Register generated figures into DataProcessor")
    parser.add_argument("figure_directory",help="The directory for saving figures")
    parser.add_argument("nodes",help="The path of JSON file containing nodes")
    parser.add_argument("figures",nargs="+",
                        help="Paths of the figures that you want to register")
    parser.add_argument("-R","--runs",dest="runs",nargs="+",
                        help="Paths of directories containing run data.",
                        default=[os.getcwd(),])
    return parser.parse_args()


def _path_expand(path):
    return os.path.expanduser(os.path.abspath(path))

def check_figure_dir(args):
    dir_path = _path_expand(args.figure_directory)
    if not os.path.isdir(dir_path):
        if os.path.exists(dir_path):
            print("Another type of file exists: " + dir_path)
            print("Exit with ERROR")
            sys.exit(1)
        ans = raw_input("Create directory(%s)? [y/N]" % dir_path)
        if ans not in ["yes", "y"]:
            print("Figure directory cannot be created. Exit with error.")
            sys.exit(1)
        os.makedirs(dir_path)
    return dir_path


def get_node_list(args):
    nodes_path = _path_expand(args.nodes)
    if os.path.exists(nodes_path):
        try:
            node_list = dataprocessor.pipes.jsonio.load([],nodes_path)
        except e:
            print("JSON file cannot be read.")
            sys.exit(1)
    else:
        print("Create new node_list: %s" % nodes_path)
        node_list = []
    return nodes_path, node_list


def check_figures(args):
    for fig in args.figures:
        path = _path_expand(fig)
        if not os.path.exists(path):
            print("Figure %s does not found." % path)
            sys.exit(1)


def check_runs(args):
    for run in args.runs:
        path = _path_expand(run)
        if not os.path.exists(path):
            print("Run directory %s does not found." % path)
            sys.exit(1)


def main():
    args = read_args()
    dir_path = check_figure_dir(args)
    nodes_path, node_list = get_node_list(args)
    check_figures(args)
    check_runs(args)

    dataprocessor.pipes.jsonio.save(node_list, nodes_path, ask_replace=False)


if __name__ == "__main__":
    main()
else:
    raise RuntimeError("registerfigure should not be imported")
