#!/usr/bin/python
# coding=utf-8


import argparse
import os.path
import sys
import json

sys.path = ([sys.path[0]]
            + [os.path.join(os.path.dirname(__file__), "../lib")]
            + sys.path[1:])
import dataprocessor.pipes.jsonio
import dataprocessor.pipes.figure
sys.path = [sys.path[0]] + sys.path[2:]


def main():
    parser = argparse.ArgumentParser(description="Register generated figures into DataProcessor")
    parser.add_argument("figure_directory",help="The directory for saving figures")
    parser.add_argument("nodes",help="The path of JSON file containing nodes")
    parser.add_argument("figures",nargs="+",
                        help="Filenames of the figures that you want to register")
    parser.add_argument("-R","--runs",dest="runs",nargs="+",
                        help="Paths of directories containing run data.",
                        default=[os.getcwd(),])
    args = parser.parse_args()

    # figure directory
    dir_path = os.path.expanduser(os.path.abspath(args.figure_directory))
    if not os.path.isdir(dir_path):
        if os.path.exists(dir_path):
            print("Another type of file exists: " + dir_path)
            print("Exit with ERROR")
            sys.exit(1)
        ans = raw_input("Create directory(%s)? [y/N]" % dir_path)
        if ans not in ["yes", "y"]:
            print("Figure directory cannot be created. Exit with error.")
            sys.exit(1)
        os.makedirs(dir_path)

    nodes_path = os.path.expanduser(os.path.abspath(args.nodes))
    if os.path.exists(nodes_path):
        try:
            node_list = dataprocessor.pipes.jsonio.load([],nodes_path)
        except e:
            print("JSON file cannot be read.")
            sys.exit(1)
    else:
        node_list = []

    dataprocessor.pipes.jsonio.save(node_list, nodes_path, ask_replace=False)


if __name__ == "__main__":
    main()
else:
    raise RuntimeError("registerfigure should not be imported")
