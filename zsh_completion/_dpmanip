#compdef dpmanip
function _dpmanip-add_comment (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-filter_node_type (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-normalize (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-configure (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--section)--section[section]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-scan_directory (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--followlinks)--followlinks[whether scan in symbolic link]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-add_node (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--path)--path[path]: :_files' \
        '(--node_type)--node_type[node_type]: :_files' \
        '(--children)--children[children]: :_files' \
        '(--name)--name[name]: :_files' \
        '(--parents)--parents[parents]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-change_path (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--silent)--silent[silent]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-load_json (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-add_run (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--tag)--tag[tag]: :_files' \
        '(--name)--name[name]: :_files' \
        '(--comment)--comment[comment]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-add_conf (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-filter_project (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-add_tag (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-filter_prefix (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-configure_no_section (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--split_char)--split_char[split_char]: :_files' \
        '(--comment_char)--comment_char[comment_char]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-save_json (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--silent)--silent[silent]: :_files' \
        '*::arguments:_files'
}


function _dpmanip-move_node (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-untag (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '*::arguments:_files'
}


function _dpmanip-register_figure (){
    typeset -A opt_args
    local context state line

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--runs)--runs[runs]: :_files' \
        '(--generators)--generators[generators]: :_files' \
        '*::arguments:_files'
}

function _dpmanip_subcmd_list() {
    local -a subcmd_list
    subcmd_list=(
        add_comment:'add comment to node with path'
        filter_node_type:'filter by node type. This pipe filters out nodes which has different type attribute, and should be used with '\''-o'\'' option in dpmanip.'
        register_figure:'add figure node into node_list'
        configure:'Read parameter file (use ConfigParser)'
        add_node:'Add node to node_list.'
        change_path:'change path of node'
        add_run:'Add run.'
        add_conf:'Add a new configure to the path.'
        filter_project:'filter by project path. This pipe filters out runs which don'\''t belong to the project, and should be used with '\''-o'\'' in dpmanip.'
        normalize:'normalize nodes (i.e. fill necessary field)'
        load_json:'load node_list from a JSON file'
        scan_directory:'Scan nodes from all directories under the directory '\''root'\''.'
        add_tag:'Add a tag into the node'
        save_json:'save node_list in a JSON file'
        filter_prefix:'filter by prefix_path. This pipe filters out runs, projects and figures whose path does not start with the prefix, and should be used with '\''-o'\'' option in dpmanip.'
        move_node:'move node whose directory is also moved like as UNIX mv'
        untag:'remove a tag from specified path'
        configure_no_section:'Read parameter file (without section)'
    )
    _describe -t subcmd 'subcommand list' subcmd_list && return
}

function _dpmanip (){
    typeset -A opt_args
    local context state line

    integer int=1

    _arguments -w -s -S \
        '(-h --help)'{-h,--help}'[show this help message and exit]' \
        '(--json)--json[path of JSON file]: :_files' \
        '(--debug)--debug[output traceback]' \
        '(-s --silent)'{-s,--silent}'[Does not ask whether REPLACE JSON file]' \
        '(-i --input)'{-i,--input}'[Use stdin as data JSON]' \
        '(-o --output)'{-o,--output}'[Output result node_list]' \
        '(-r --replace)'{-r,--replace}'[Use replace strategy for saving JSON]' \
        ':subcmd:->subcmd' \
        '*::subcmd-options-or-args:->subcmd-options-or-args'

    case $state in
        subcmd)
            _dpmanip_subcmd_list && ret=0
            ;;
        subcmd-options-or-args)
            local curcontext=$curcontext
            curcontext=${curcontext%:*:*}:dpmanip-$words[1]:
            if (( $+functions[_dpmanip-$words[1]] )); then
                _call_function ret _dpmanip-$words[1]
            else
                _files && ret=0
            fi
            ;;
    esac

    return ret
}
_dpmanip